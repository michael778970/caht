<!-- This is the start of your full HTML document -->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ...[everything before remains unchanged]... -->
</head>
<body data-theme="light">
  <!-- ...[UI and structure remains unchanged]... -->

  <script>
    // --- Data Structures ---
    let userName = localStorage.getItem('username') || 'You';
    let friends = JSON.parse(localStorage.getItem('friends') || '{}');
    let selectedFriend = null;

    // Elements
    const inboxList = document.getElementById('inboxList');
    const chatMessages = document.getElementById('chatMessages');
    const chatHeader = document.getElementById('chatHeader');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const newFriendInput = document.getElementById('newFriendInput');
    const addFriendBtn = document.getElementById('addFriendBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsOverlay = document.getElementById('settingsOverlay');
    const settingsCloseBtn = document.getElementById('settingsCloseBtn');
    const usernameInput = document.getElementById('usernameInput');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const startupScreen = document.getElementById('startupScreen');
    const startChattingBtn = document.getElementById('startChattingBtn');

    usernameInput.value = userName;

    function saveData() {
      localStorage.setItem('friends', JSON.stringify(friends));
      localStorage.setItem('username', userName);
    }

    function addFriend(username) {
      username = username.trim();
      if (!username) {
        alert('Please enter a valid username.');
        return;
      }
      if (friends[username]) {
        alert('Friend already added.');
        return;
      }
      if (username === userName) {
        alert("You can't add yourself.");
        return;
      }
      friends[username] = { messages: [] };
      saveData();
      renderInbox();
      newFriendInput.value = '';
    }

    function renderInbox() {
      inboxList.innerHTML = '';
      const sortedFriends = Object.entries(friends).sort((a, b) => {
        const aMsgs = a[1].messages;
        const bMsgs = b[1].messages;
        const aLast = aMsgs.length ? aMsgs[aMsgs.length -1].timestamp : 0;
        const bLast = bMsgs.length ? bMsgs[bMsgs.length -1].timestamp : 0;
        return bLast - aLast;
      });

      for (const [friend, data] of sortedFriends) {
        const item = document.createElement('div');
        item.className = 'inbox-item';
        if (friend === selectedFriend) item.classList.add('selected');
        item.setAttribute('tabindex', '0');
        item.setAttribute('role', 'button');
        item.setAttribute('aria-label', `Chat with ${friend}`);

        const lastMsg = data.messages.length ? data.messages[data.messages.length -1] : null;
        let previewText = lastMsg ? (lastMsg.sender === 'user' ? `You: ${lastMsg.text}` : lastMsg.text) : 'No messages yet';

        const unreadCount = data.messages.reduce((acc, msg) => acc + (msg.sender === 'friend' && !msg.read ? 1 : 0), 0);

        item.innerHTML = `
          <div class="inbox-header">${friend}</div>
          <div class="inbox-preview">${previewText}</div>
        `;

        if (unreadCount > 0) {
          const badge = document.createElement('div');
          badge.className = 'unread-badge';
          badge.textContent = unreadCount;
          item.appendChild(badge);
        }

        item.onclick = () => selectFriend(friend);
        item.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectFriend(friend);
          }
        };

        inboxList.appendChild(item);
      }
    }

    function selectFriend(friend) {
      selectedFriend = friend;
      chatHeader.textContent = `Chat with ${friend}`;
      chatInput.disabled = false;
      chatInput.focus();

      if (friends[friend]) {
        for (const msg of friends[friend].messages) {
          if (msg.sender === 'friend') {
            msg.read = true;
          }
        }
      }

      saveData();
      renderInbox();
      renderMessages();
    }

    function renderMessages() {
      chatMessages.innerHTML = '';
      if (!selectedFriend) {
        chatMessages.innerHTML = '<p style="text-align:center; color:#888;">No friend selected</p>';
        chatInput.disabled = true;
        return;
      }
      const msgs = friends[selectedFriend].messages;
      for (const msg of msgs) {
        const div = document.createElement('div');
        div.className = `message ${msg.sender === 'user' ? 'user' : 'other'}`;
        div.textContent = msg.text;
        chatMessages.appendChild(div);
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // âœ… UPDATED sendMessage WITHOUT echo
    function sendMessage(text) {
      if (!selectedFriend) {
        alert('Select a friend first.');
        return;
      }
      text = text.trim();
      if (!text) return;

      friends[selectedFriend].messages.push({
        sender: 'user',
        text,
        read: true,
        timestamp: Date.now()
      });

      saveData();
      renderInbox();
      renderMessages();
    }

    // Still here for future use if needed
    function receiveMessage(friend, text) {
      if (!friends[friend]) return;

      friends[friend].messages.push({
        sender: 'friend',
        text,
        read: selectedFriend === friend,
        timestamp: Date.now()
      });

      saveData();
      renderInbox();
      if (selectedFriend === friend) {
        renderMessages();
      }
    }

    chatForm.addEventListener('submit', e => {
      e.preventDefault();
      sendMessage(chatInput.value);
      chatInput.value = '';
    });

    addFriendBtn.addEventListener('click', () => {
      addFriend(newFriendInput.value);
    });

    newFriendInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') addFriend(newFriendInput.value);
    });

    settingsBtn.addEventListener('click', () => {
      usernameInput.value = userName;
      darkModeToggle.checked = document.body.getAttribute('data-theme') === 'dark';
      settingsOverlay.classList.add('active');
      usernameInput.focus();
    });

    settingsCloseBtn.addEventListener('click', () => {
      settingsOverlay.classList.remove('active');
    });

    settingsOverlay.addEventListener('click', e => {
      if (e.target === settingsOverlay) {
        settingsOverlay.classList.remove('active');
      }
    });

    usernameInput.addEventListener('input', () => {
      const val = usernameInput.value.trim();
      if (val) userName = val;
      saveData();
    });

    darkModeToggle.addEventListener('change', () => {
      document.body.setAttribute('data-theme', darkModeToggle.checked ? 'dark' : 'light');
    });

    startChattingBtn.addEventListener('click', () => {
      startupScreen.classList.add('hidden');
      setTimeout(() => {
        startupScreen.style.display = 'none';
      }, 300);
    });

    renderInbox();
    renderMessages();
    chatInput.disabled = true;
  </script>
</body>
</html>
